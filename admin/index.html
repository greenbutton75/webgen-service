<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebGen Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50: '#eff6ff', 500: '#3b82f6', 700: '#1d4ed8', 900: '#1e3a8a' }
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }
    .status-done     { @apply bg-emerald-100 text-emerald-700 border border-emerald-200; }
    .status-error    { @apply bg-red-100 text-red-700 border border-red-200; }
    .status-pending  { @apply bg-amber-100 text-amber-700 border border-amber-200; }
    .status-processing { @apply bg-blue-100 text-blue-700 border border-blue-200 animate-pulse; }
  </style>
</head>
<body class="bg-gray-950 min-h-screen text-gray-100 font-sans">

<div x-data="admin()" x-init="init()" x-cloak>

  <!-- Top bar -->
  <header class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
        <i class="fas fa-code text-white text-sm"></i>
      </div>
      <h1 class="font-bold text-lg tracking-tight">WebGen Admin</h1>
    </div>
    <div class="flex items-center gap-4">
      <!-- Stats -->
      <div class="hidden sm:flex items-center gap-5 text-sm text-gray-400">
        <span><span class="text-emerald-400 font-semibold" x-text="stats.done"></span> done</span>
        <span><span class="text-amber-400 font-semibold" x-text="stats.pending + stats.processing"></span> in queue</span>
        <span><span class="text-red-400 font-semibold" x-text="stats.error"></span> errors</span>
      </div>
      <!-- Auto-refresh toggle -->
      <button @click="toggleAutoRefresh()"
        :class="autoRefresh ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'"
        class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
        <i class="fas" :class="autoRefresh ? 'fa-pause' : 'fa-play'"></i>
        <span x-text="autoRefresh ? 'Auto-refresh ON' : 'Auto-refresh OFF'"></span>
      </button>
      <button @click="loadJobs()" class="p-2 hover:bg-gray-800 rounded-lg transition-colors text-gray-400 hover:text-white">
        <i class="fas fa-rotate-right text-sm" :class="loading && 'fa-spin'"></i>
      </button>
    </div>
  </header>

  <!-- Filter bar -->
  <div class="bg-gray-900 border-b border-gray-800 px-6 py-3 flex items-center gap-3 flex-wrap">
    <span class="text-sm text-gray-500">Filter:</span>
    <template x-for="f in ['all', 'done', 'processing', 'pending', 'error']" :key="f">
      <button
        @click="filter = f"
        :class="filter === f
          ? 'bg-blue-600 text-white'
          : 'bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700'"
        class="px-3 py-1 rounded-full text-xs font-medium capitalize transition-colors">
        <span x-text="f"></span>
        <span class="ml-1 opacity-70" x-text="'(' + (f === 'all' ? jobs.length : jobs.filter(j => j.status === f).length) + ')'"></span>
      </button>
    </template>
    <div class="flex-1"></div>
    <input
      type="text"
      x-model="search"
      placeholder="Search domain..."
      class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:border-blue-500 w-48"
    />
  </div>

  <!-- Main content -->
  <main class="px-6 py-6 max-w-screen-2xl mx-auto">

    <!-- Empty state -->
    <template x-if="!loading && filteredJobs.length === 0">
      <div class="text-center py-20 text-gray-600">
        <i class="fas fa-inbox text-5xl mb-4"></i>
        <p class="text-lg">No jobs found</p>
        <p class="text-sm mt-1" x-show="filter !== 'all'">Try changing the filter</p>
      </div>
    </template>

    <!-- Jobs table -->
    <template x-if="filteredJobs.length > 0">
      <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-800 text-gray-500 text-xs uppercase tracking-wider">
              <th class="text-left px-5 py-3 font-medium">Domain</th>
              <th class="text-left px-5 py-3 font-medium">Status</th>
              <th class="text-left px-4 py-3 font-medium hidden md:table-cell">Tokens</th>
              <th class="text-left px-4 py-3 font-medium hidden lg:table-cell">Strategy</th>
              <th class="text-left px-4 py-3 font-medium hidden xl:table-cell">Created</th>
              <th class="text-right px-5 py-3 font-medium">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="job in filteredJobs" :key="job.id">
              <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">

                <!-- Domain + job id -->
                <td class="px-5 py-4">
                  <div class="font-medium text-gray-200" x-text="job.domain || '—'"></div>
                  <div class="text-xs text-gray-600 font-mono mt-0.5" x-text="job.id.slice(0, 8) + '...'"></div>
                </td>

                <!-- Status badge -->
                <td class="px-5 py-4">
                  <div>
                    <span
                      class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold capitalize"
                      :class="'status-' + job.status">
                      <i class="fas text-xs"
                        :class="{
                          'fa-circle-check': job.status === 'done',
                          'fa-circle-xmark': job.status === 'error',
                          'fa-clock': job.status === 'pending',
                          'fa-circle-notch fa-spin': job.status === 'processing'
                        }">
                      </i>
                      <span x-text="job.status"></span>
                    </span>
                    <!-- Error tooltip -->
                    <div x-show="job.status === 'error' && job.error" class="text-xs text-red-400 mt-1 max-w-xs truncate" x-text="job.error"></div>
                  </div>
                </td>

                <!-- Tokens -->
                <td class="px-4 py-4 text-gray-400 hidden md:table-cell">
                  <span x-text="job.snapshot_tokens ? (job.snapshot_tokens / 1000).toFixed(1) + 'k' : '—'"></span>
                </td>

                <!-- Strategy -->
                <td class="px-4 py-4 hidden lg:table-cell">
                  <span
                    x-show="job.strategy"
                    class="text-xs px-2 py-0.5 rounded bg-gray-800 text-gray-400 font-mono"
                    x-text="job.strategy">
                  </span>
                </td>

                <!-- Created at -->
                <td class="px-4 py-4 text-gray-500 text-xs hidden xl:table-cell" x-text="formatDate(job.created_at)"></td>

                <!-- Actions -->
                <td class="px-5 py-4">
                  <div class="flex items-center justify-end gap-2">
                    <a
                      x-show="job.status === 'done'"
                      :href="'/download/' + job.id"
                      class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-xs font-medium transition-colors"
                      :title="'Download ' + (job.domain || job.id) + '.zip'">
                      <i class="fas fa-download"></i>
                      <span class="hidden sm:inline">Download</span>
                    </a>
                    <button
                      @click="confirmDelete(job)"
                      class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-800 hover:bg-red-900/50 text-gray-400 hover:text-red-400 rounded-lg text-xs font-medium transition-colors"
                      title="Delete job">
                      <i class="fas fa-trash-can"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

  </main>

  <!-- Delete confirmation modal -->
  <template x-if="deleteTarget">
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" @click.self="deleteTarget = null">
      <div class="bg-gray-900 border border-gray-700 rounded-2xl p-7 max-w-sm w-full shadow-2xl">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-red-900/50 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-trash-can text-red-400"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-100">Delete Job</h3>
            <p class="text-gray-400 text-sm" x-text="'Domain: ' + (deleteTarget?.domain || deleteTarget?.id)"></p>
          </div>
        </div>
        <p class="text-gray-400 text-sm mb-6">This will permanently delete the job and its ZIP file.</p>
        <div class="flex gap-3">
          <button @click="deleteTarget = null" class="flex-1 px-4 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-xl text-sm font-medium transition-colors">Cancel</button>
          <button @click="deleteJob(deleteTarget)" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-xl text-sm font-medium transition-colors">Delete</button>
        </div>
      </div>
    </div>
  </template>

</div>

<script>
function admin() {
  return {
    jobs: [],
    loading: false,
    filter: 'all',
    search: '',
    autoRefresh: true,
    _refreshTimer: null,
    deleteTarget: null,

    get filteredJobs() {
      return this.jobs.filter(j => {
        const matchFilter = this.filter === 'all' || j.status === this.filter;
        const matchSearch = !this.search || (j.domain || '').toLowerCase().includes(this.search.toLowerCase());
        return matchFilter && matchSearch;
      });
    },

    get stats() {
      return {
        done:       this.jobs.filter(j => j.status === 'done').length,
        pending:    this.jobs.filter(j => j.status === 'pending').length,
        processing: this.jobs.filter(j => j.status === 'processing').length,
        error:      this.jobs.filter(j => j.status === 'error').length,
      };
    },

    async init() {
      await this.loadJobs();
      this.startAutoRefresh();
    },

    async loadJobs() {
      this.loading = true;
      try {
        const res = await fetch('/jobs');
        this.jobs = await res.json();
      } catch (e) {
        console.error('Failed to load jobs:', e);
      } finally {
        this.loading = false;
      }
    },

    startAutoRefresh() {
      this._refreshTimer = setInterval(() => {
        if (this.autoRefresh) this.loadJobs();
      }, 8000);
    },

    toggleAutoRefresh() {
      this.autoRefresh = !this.autoRefresh;
    },

    confirmDelete(job) {
      this.deleteTarget = job;
    },

    async deleteJob(job) {
      try {
        await fetch(`/jobs/${job.id}`, { method: 'DELETE' });
        this.jobs = this.jobs.filter(j => j.id !== job.id);
      } catch (e) {
        console.error('Delete failed:', e);
      } finally {
        this.deleteTarget = null;
      }
    },

    formatDate(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso + 'Z');
        return d.toLocaleString(undefined, {
          month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
      } catch { return iso; }
    }
  }
}
</script>
</body>
</html>
