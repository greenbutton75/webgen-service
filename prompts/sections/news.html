<!-- ═══════════════════════════════════════════════════════════════
     NEWS & AI BRIEFING SECTION
     DO NOT modify any JavaScript or fetch() calls.
     Style the CSS classes below to match the site design.
     Required classes to style: .news-section, .news-section__header,
       .news-eyebrow, .news-section__title, .news-section__subtitle,
       .news-briefing, .news-briefing__inner, .news-briefing__icon-wrap,
       .news-briefing__title, .news-briefing__date-badge, .news-briefing__subtitle,
       .news-briefing__grid, .news-briefing__takeaways, .news-briefing__actions,
       .news-briefing__actions-label, .news-action-item,
       .news-cards, .news-card, .news-card__tag, .news-card__date,
       .news-card__title, .news-card__source, .news-card__summary, .news-card__link,
       .news-loading
     ═══════════════════════════════════════════════════════════════ -->
<section id="market-intelligence" x-data="newsSection()" x-init="init()" class="news-section">
  <div class="news-section__container">

    <div class="news-section__header">
      <div class="news-eyebrow">Market Intelligence</div>
      <h2 class="news-section__title">Latest Insights</h2>
      <p class="news-section__subtitle">Stay current with the latest developments in retirement planning and fiduciary compliance.</p>
    </div>

    <template x-if="loading">
      <div class="news-loading">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span>Loading market intelligence...</span>
      </div>
    </template>

    <template x-if="!loading && briefing">
      <div class="news-briefing">
        <div class="news-briefing__inner">
          <div class="news-briefing__header">
            <div class="news-briefing__icon-wrap">
              <i class="fas fa-sparkles"></i>
            </div>
            <div>
              <h3 class="news-briefing__title">
                AI Executive Briefing
                <span class="news-briefing__date-badge" x-text="'Generated ' + briefing.generatedDate"></span>
              </h3>
              <p class="news-briefing__subtitle">Synthesized analysis for Plan Sponsors</p>
            </div>
          </div>
          <div class="news-briefing__grid">
            <div class="news-briefing__takeaways">
              <h4>Key Takeaways</h4>
              <p x-text="briefing.keyTakeaways"></p>
            </div>
            <div class="news-briefing__actions">
              <h4 class="news-briefing__actions-label">
                <i class="fas fa-circle-info"></i>
                Actionable Conclusions
              </h4>
              <ul>
                <template x-for="item in parsedActionItems" :key="item">
                  <li class="news-action-item">
                    <i class="fas fa-circle-check"></i>
                    <span x-html="item"></span>
                  </li>
                </template>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template x-if="!loading && articles.length > 0">
      <div class="news-cards">
        <template x-for="article in articles" :key="article.id">
          <div class="news-card">
            <div class="news-card__meta">
              <span class="news-card__tag" x-text="article.tag"></span>
              <span class="news-card__date" x-text="article.date"></span>
            </div>
            <h4 class="news-card__title" x-text="article.title"></h4>
            <p class="news-card__source" x-text="'Source: ' + article.source"></p>
            <p class="news-card__summary" x-text="article.summary"></p>
            <a :href="article.url" target="_blank" rel="noopener noreferrer" class="news-card__link">
              Read Full Article
              <i class="fas fa-arrow-up-right-from-square"></i>
            </a>
          </div>
        </template>
      </div>
    </template>

  </div>
</section>

<script>
function newsSection() {
  return {
    articles: [],
    briefing: null,
    loading: true,
    parsedActionItems: [],

    async init() {
      try {
        const res = await fetch('/api/get-news');
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        this.articles = (data.articles || []).slice(0, 6);
        this.briefing = data.briefing || null;
        if (this.briefing?.actionItems) {
          try {
            const items = JSON.parse(this.briefing.actionItems);
            this.parsedActionItems = items.map(i =>
              i.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            );
          } catch { this.parsedActionItems = []; }
        }
      } catch (e) {
        console.error('Failed to load news:', e);
      } finally {
        this.loading = false;
      }
    }
  }
}
</script>
