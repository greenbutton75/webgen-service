<!-- ═══════════════════════════════════════════════════════════════
     RETIREMENT PLAN SEARCH + STRATEGY SECTION
     DO NOT modify any JavaScript or fetch() calls.
     Style the CSS classes below to match the site design.
     Required classes to style: .plan-section, .plan-section__container,
       .plan-section__header, .plan-eyebrow, .plan-section__title,
       .plan-section__subtitle, .plan-search-wrap, .plan-search-input,
       .plan-spinner, .plan-dropdown, .plan-dropdown__item,
       .plan-dropdown__name, .plan-dropdown__plan, .plan-dropdown__location,
       .plan-selected-title, .plan-selected-subtitle,
       .plan-loading, .plan-loading__spinner, .plan-loading__text,
       .plan-cards, .plan-card, .plan-card--strengths, .plan-card--issues,
       .plan-card--actions, .plan-card__icon, .plan-card__label,
       .plan-card__title, .plan-card__list, .plan-card__list-item,
       .plan-error
     ═══════════════════════════════════════════════════════════════ -->
<section id="plan-health-check" x-data="planSection()" class="plan-section">
  <div class="plan-section__container">

    <div class="plan-section__header">
      <div class="plan-eyebrow">Retirement Plan Tool</div>
      <h2 class="plan-section__title">Your Retirement Plan Health Check</h2>
      <p class="plan-section__subtitle">
        Get an instant assessment of your company's retirement plan.
        Search by company name or EIN to see personalized insights and recommendations.
      </p>
    </div>

    <div class="plan-search-wrap">
      <div style="position:relative;">
        <i class="fas fa-magnifying-glass" style="position:absolute;left:1.2rem;top:50%;transform:translateY(-50%);pointer-events:none;"></i>
        <input
          type="text"
          x-model="query"
          @input.debounce.350ms="search()"
          @keydown.escape="results = []"
          placeholder="Search by company name or EIN..."
          class="plan-search-input"
        />
        <i x-show="searching" class="fas fa-circle-notch fa-spin plan-spinner"></i>
      </div>

      <template x-if="results.length > 0">
        <div class="plan-dropdown">
          <template x-for="plan in results" :key="plan.ackId">
            <button @click="selectPlan(plan)" class="plan-dropdown__item">
              <div>
                <div class="plan-dropdown__name">
                  <i class="fas fa-building"></i>
                  <span x-text="plan.sponsorName"></span>
                </div>
                <div class="plan-dropdown__plan" x-text="plan.planName"></div>
                <div class="plan-dropdown__location">
                  <i class="fas fa-location-dot"></i>
                  <span x-text="plan.city + ', ' + plan.state"></span>
                </div>
              </div>
              <i class="fas fa-chevron-right"></i>
            </button>
          </template>
        </div>
      </template>
    </div>

    <template x-if="selectedPlan">
      <div>
        <div class="plan-section__header" style="margin-top:3rem;">
          <h3 class="plan-selected-title" x-text="selectedPlan.sponsorName"></h3>
          <p class="plan-selected-subtitle" x-text="selectedPlan.planName"></p>
        </div>

        <template x-if="strategyLoading">
          <div class="plan-loading">
            <div class="plan-loading__spinner">
              <div class="plan-loading__ring"></div>
              <div class="plan-loading__ring plan-loading__ring--spin"></div>
              <i class="fas fa-robot"></i>
            </div>
            <div class="plan-loading__text">
              <p>AI is analyzing your plan...</p>
              <span>This typically takes 15–30 seconds</span>
            </div>
          </div>
        </template>

        <template x-if="strategy && !strategyLoading">
          <div class="plan-cards">

            <div class="plan-card plan-card--strengths">
              <div class="plan-card__icon">
                <i class="fas fa-star"></i>
              </div>
              <div>
                <div class="plan-card__label">Plan strengths</div>
                <h4 class="plan-card__title">Strengths</h4>
              </div>
              <ul class="plan-card__list">
                <template x-for="s in strategy.strengths" :key="s">
                  <li class="plan-card__list-item">
                    <span>•</span>
                    <span x-text="s"></span>
                  </li>
                </template>
              </ul>
            </div>

            <div class="plan-card plan-card--issues">
              <div class="plan-card__icon">
                <i class="fas fa-triangle-exclamation"></i>
              </div>
              <div>
                <div class="plan-card__label">Deficiencies</div>
                <h4 class="plan-card__title">Areas to Improve</h4>
              </div>
              <ul class="plan-card__list">
                <template x-for="d in strategy.deficiencies" :key="d">
                  <li class="plan-card__list-item">
                    <span>•</span>
                    <span x-text="d"></span>
                  </li>
                </template>
              </ul>
            </div>

            <div class="plan-card plan-card--actions">
              <div class="plan-card__icon">
                <i class="fas fa-list-check"></i>
              </div>
              <div>
                <div class="plan-card__label">Next steps</div>
                <h4 class="plan-card__title">Action Plan</h4>
              </div>
              <ol class="plan-card__list">
                <template x-for="(step, idx) in strategy.actionSteps" :key="step">
                  <li class="plan-card__list-item">
                    <span x-text="(idx + 1) + '.'"></span>
                    <span x-text="step"></span>
                  </li>
                </template>
              </ol>
            </div>

          </div>
        </template>

        <template x-if="strategyError && !strategyLoading">
          <div class="plan-error">
            <i class="fas fa-circle-xmark"></i>
            <p>Could not load strategy analysis. Please try again.</p>
          </div>
        </template>
      </div>
    </template>

  </div>
</section>

<script>
function planSection() {
  return {
    query: '',
    results: [],
    searching: false,
    selectedPlan: null,
    strategy: null,
    strategyLoading: false,
    strategyError: false,

    async search() {
      if (this.query.length < 2) { this.results = []; return; }
      this.searching = true;
      try {
        const res = await fetch('/api/plan-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: this.query, count: 10 })
        });
        const data = await res.json();
        this.results = data.records || [];
      } catch (e) {
        this.results = [];
      } finally {
        this.searching = false;
      }
    },

    async selectPlan(plan) {
      this.selectedPlan = plan;
      this.results = [];
      this.query = plan.sponsorName;
      this.strategy = null;
      this.strategyError = false;
      this.strategyLoading = true;
      try {
        const res = await fetch('/api/plan-strategy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ein: plan.ein, pn: plan.pn, planName: plan.planName })
        });
        const data = await res.json();
        this.strategy = data;
      } catch (e) {
        this.strategyError = true;
      } finally {
        this.strategyLoading = false;
      }
    }
  }
}
</script>
